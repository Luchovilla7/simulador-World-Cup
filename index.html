<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Mundial de F√∫tbol</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            text-align: center;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-content {
            padding: 20px;
        }
        
        .selector-section, .draw-section, .groups-section, .knockout-section, .final-section {
            background: #f9f9f9;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: none; /* Ocultar por defecto */
        }
        
        .section.active {
            display: block; /* Mostrar solo la secci√≥n activa */
        }

        .selector-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .selector-section select,
        .start-btn,
        .draw-btn,
        .simulate-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .selector-section select:focus,
        .start-btn:hover,
        .draw-btn:hover,
        .simulate-btn:hover {
            border-color: #764ba2;
            box-shadow: 0 0 8px rgba(118, 75, 162, 0.3);
        }
        
        .start-btn,
        .draw-btn,
        .simulate-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .start-btn:hover,
        .draw-btn:hover,
        .simulate-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        h3 {
            color: #4a4a4a;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }
        
        .groups-container, .matches-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .group, .match {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .team {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .team:last-child {
            border-bottom: none;
        }
        
        .team-info {
            display: flex;
            align-items: center;
        }
        
        .team-name {
            font-weight: bold;
            color: #555;
            margin-right: 5px;
        }
        
        .stars {
            color: gold;
        }
        
        .group-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .group-table th, .group-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .group-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #555;
        }

        .group-table .qualified {
            background-color: #e0ffe0; /* Fondo verde claro para clasificados */
            font-weight: bold;
        }
        
        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .score {
            font-weight: bold;
            color: #764ba2;
        }
        
        .match.champion-celebration {
            background-color: #ffe0b2; /* Color naranja claro para partidos del campe√≥n */
            border: 2px solid orange;
        }
        
        .champion-celebration {
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            color: #d4af37; /* Color dorado */
            margin-top: 30px;
            padding: 20px;
            background-color: #fffacd;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .phase-navigation {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .phase-btn {
            background-color: #adb5bd;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .phase-btn:hover {
            background-color: #6c757d;
        }

        .phase-btn.active {
            background-color: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Simulador Mundial de F√∫tbol</h1>
            <p>¬°Simula tu propio mundial!</p>
        </div>

        <div class="main-content">
            <div class="phase-navigation">
                <button class="phase-btn active" onclick="showPhase('selector')">Inicio</button>
                <button class="phase-btn" onclick="showPhase('draw')">Sorteo de Grupos</button>
                <button class="phase-btn" onclick="showPhase('groups')">Fase de Grupos</button>
                <button class="phase-btn" onclick="showPhase('knockout')">Eliminatorias</button>
                <button class="phase-btn" onclick="showPhase('final')">Final</button>
            </div>

            <div id="selector" class="section selector-section active">
                <h3>Elige tu campe√≥n y comienza</h3>
                <label for="championSelect">Selecciona tu equipo campe√≥n:</label>
                <select id="championSelect"></select>
                <button class="start-btn" onclick="startTournament()">‚ñ∂Ô∏è Iniciar Simulaci√≥n</button>
            </div>

            <div id="draw" class="section draw-section">
                <h3>Sorteo de Grupos</h3>
                <div id="drawContent">
                    <p>Haz clic en "Realizar Sorteo" para ver los grupos.</p>
                    </div>
            </div>

            <div id="groups" class="section groups-section">
                <h3>Resultados de la Fase de Grupos</h3>
                <div id="groupsContent">
                    </div>
            </div>

            <div id="knockout" class="section knockout-section">
                <h3>Fase Eliminatoria</h3>
                <div id="knockoutContent">
                    </div>
            </div>

            <div id="final" class="section final-section">
                <h3>Final del Mundial</h3>
                <div id="finalContent">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de pa√≠ses con sus niveles
        const countries = {
            // CONMEBOL (Sudam√©rica) - 5 clasificados
            'Brasil': 5, 'Argentina': 5, 'Uruguay': 4, 'Colombia': 4, 'Chile': 3,
            'Per√∫': 3, 'Ecuador': 3, 'Paraguay': 2, 'Bolivia': 2, 'Venezuela': 2,
            
            // UEFA (Europa) - 11 clasificados
            'Francia': 5, 'Espa√±a': 5, 'Inglaterra': 5, 'Alemania': 5, 'Italia': 5,
            'Portugal': 5, 'Pa√≠ses Bajos': 4, 'B√©lgica': 4, 'Croacia': 4, 'Dinamarca': 4,
            'Suecia': 3, 'Suiza': 3, 'Austria': 3, 'Polonia': 3, 'Rep√∫blica Checa': 3,
            'Ucrania': 3, 'Serbia': 3, 'Eslovaquia': 2, 'Hungr√≠a': 2, 'Finlandia': 2,
            
            // CONCACAF (Norte y Centroam√©rica) - 4 clasificados
            'Estados Unidos': 4, 'M√©xico': 4, 'Canad√°': 3, 'Costa Rica': 3,
            'Jamaica': 2, 'Honduras': 2, 'El Salvador': 2, 'Guatemala': 2,
            'Panam√°': 2, 'Nicaragua': 1, 'Trinidad y Tobago': 2,
            
            // CAF (√Åfrica) - 5 clasificados
            'Senegal': 4, 'Marruecos': 4, 'Nigeria': 4, 'Ghana': 3, 'Argelia': 3,
            'T√∫nez': 3, 'Camer√∫n': 3, 'Mali': 3, 'Burkina Faso': 2, 'Costa de Marfil': 3,
            'Egipto': 3, 'Sud√°frica': 2, 'Kenia': 2, 'Angola': 2, 'Zambia': 2,
            
            // AFC (Asia) - 5 clasificados
            'Jap√≥n': 4, 'Corea del Sur': 4, 'Australia': 4, 'Ir√°n': 3, 'Arabia Saud√≠': 3,
            'Qatar': 3, 'Irak': 3, 'Emiratos √Årabes': 2, 'Jordania': 2, 'China': 2,
            'Tailandia': 2, 'Vietnam': 2, 'India': 2, 'Uzbekist√°n': 2,
            
            // OFC (Ocean√≠a) - 2 clasificados
            'Nueva Zelanda': 2, 'Fiji': 1, 'Islas Salom√≥n': 1, 'Nueva Caledonia': 1,
            'Vanuatu': 1, 'Tahit√≠': 1, 'Samoa': 1, 'Tonga': 1
        };
        
        let qualifiedTeams = [];
        let groups = {};
        let chosenChampion = '';
        let knockoutResults = {};
        let finalResults = {};
        let qualifiedTeamsForKnockoutGlobal = []; // Nueva variable global para los clasificados de grupos

        // Inicializar selector de campe√≥n
        function initializeChampionSelector() {
            const select = document.getElementById('championSelect');
            const sortedCountries = Object.keys(countries).sort();
            
            sortedCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = `${country} ${'‚≠ê'.repeat(countries[country])}`;
                select.appendChild(option);
            });
        }
        
        // Clasificaci√≥n autom√°tica de equipos
        function qualifyTeams() {
            const regions = {
                CONMEBOL: ['Brasil', 'Argentina', 'Uruguay', 'Colombia', 'Chile'],
                UEFA: ['Francia', 'Espa√±a', 'Inglaterra', 'Alemania', 'Italia', 'Portugal', 
                       'Pa√≠ses Bajos', 'B√©lgica', 'Croacia', 'Dinamarca', 'Suecia'],
                CONCACAF: ['Estados Unidos', 'M√©xico', 'Canad√°', 'Costa Rica'],
                CAF: ['Senegal', 'Marruecos', 'Nigeria', 'Ghana', 'Argelia'],
                AFC: ['Jap√≥n', 'Corea del Sur', 'Australia', 'Ir√°n', 'Arabia Saud√≠'],
                OFC: ['Nueva Zelanda', 'Fiji']
            };
            
            qualifiedTeams = [];
            Object.values(regions).forEach(region => {
                qualifiedTeams.push(...region);
            });
            
            // Asegurar que el campe√≥n elegido est√© clasificado
            if (chosenChampion && !qualifiedTeams.includes(chosenChampion)) {
                // Reemplazar un equipo aleatorio de la misma regi√≥n
                const championRegion = getRegion(chosenChampion);
                const regionTeams = regions[championRegion] || [];
                if (regionTeams.length > 0) {
                    const randomIndex = Math.floor(Math.random() * regionTeams.length);
                    const indexInQualified = qualifiedTeams.indexOf(regionTeams[randomIndex]);
                    if (indexInQualified !== -1) {
                        qualifiedTeams[indexInQualified] = chosenChampion;
                    }
                }
            }
        }
        
        function getRegion(country) {
            const regions = {
                CONMEBOL: ['Brasil', 'Argentina', 'Uruguay', 'Colombia', 'Chile', 'Per√∫', 'Ecuador', 'Paraguay', 'Bolivia', 'Venezuela'],
                UEFA: ['Francia', 'Espa√±a', 'Inglaterra', 'Alemania', 'Italia', 'Portugal', 'Pa√≠ses Bajos', 'B√©lgica', 'Croacia', 'Dinamarca', 'Suecia', 'Suiza', 'Austria', 'Polonia', 'Rep√∫blica Checa', 'Ucrania', 'Serbia', 'Eslovaquia', 'Hungr√≠a', 'Finlandia'],
                CONCACAF: ['Estados Unidos', 'M√©xico', 'Canad√°', 'Costa Rica', 'Jamaica', 'Honduras', 'El Salvador', 'Guatemala', 'Panam√°', 'Nicaragua', 'Trinidad y Tobago'],
                CAF: ['Senegal', 'Marruecos', 'Nigeria', 'Ghana', 'Argelia', 'T√∫nez', 'Camer√∫n', 'Mali', 'Burkina Faso', 'Costa de Marfil', 'Egipto', 'Sud√°frica', 'Kenia', 'Angola', 'Zambia'],
                AFC: ['Jap√≥n', 'Corea del Sur', 'Australia', 'Ir√°n', 'Arabia Saud√≠', 'Qatar', 'Irak', 'Emiratos √Årabes', 'Jordania', 'China', 'Tailandia', 'Vietnam', 'India', 'Uzbekist√°n'],
                OFC: ['Nueva Zelanda', 'Fiji', 'Islas Salom√≥n', 'Nueva Caledonia', 'Vanuatu', 'Tahit√≠', 'Samoa', 'Tonga']
            };
            
            for (const [region, teams] of Object.entries(regions)) {
                if (teams.includes(country)) return region;
            }
            return 'UEFA'; // Default
        }
        
        // Realizar sorteo de grupos
        function performDraw() {
            const shuffled = [...qualifiedTeams].sort(() => Math.random() - 0.5);
            groups = {}; // Asegurarse de que 'groups' sea la variable global
            
            for (let i = 0; i < 8; i++) {
                const groupLetter = String.fromCharCode(65 + i);
                groups[groupLetter] = [];
                for (let j = 0; j < 4; j++) {
                    groups[groupLetter].push(shuffled[i * 4 + j]);
                }
            }
            
            displayDraw();
        }
        
        function displayDraw() {
            const content = document.getElementById('drawContent');
            let html = '<h3>Grupos Sorteados</h3><div class="groups-container">';
            
            Object.entries(groups).forEach(([letter, teams]) => {
                html += `<div class="group">
                    <h3>Grupo ${letter}</h3>`;
                teams.forEach(team => {
                    html += `<div class="team">
                        <div class="team-info">
                            <span class="team-name">${team}</span>
                            <span class="stars">${'‚≠ê'.repeat(countries[team])}</span>
                        </div>
                    </div>`;
                });
                html += '</div>';
            });
            
            html += '</div>';
            
            // A√±adir el bot√≥n para simular la fase de grupos
            html += `<div style="text-align: center; margin-top: 30px;">
                        <button class="simulate-btn" onclick="simulateGroupsAndShow()">‚ñ∂Ô∏è Simular Fase de Grupos</button>
                    </div>`;
            content.innerHTML = html;
            showPhase('draw'); // Asegura que la fase de sorteo se mantenga activa y se muestre el contenido
        }

        // Nueva funci√≥n para simular tanda de penales
        function simulatePenalties(team1, team2) {
            let score1 = 0;
            let score2 = 0;
            const maxRounds = 5; // M√≠nimo 5 rondas
            let winner = '';

            for (let i = 0; i < maxRounds; i++) {
                if (Math.random() < 0.5) score1++; // Simula un gol
                if (Math.random() < 0.5) score2++;
            }

            // Si hay empate despu√©s de 5 rondas, ir a muerte s√∫bita
            while (score1 === score2) {
                if (Math.random() < 0.5) score1++;
                if (Math.random() < 0.5) score2++;
            }

            winner = (score1 > score2) ? team1 : team2;
            return { score1, score2, winner };
        }
        
        // Simular partido
        function simulateMatch(team1, team2, isFinal = false, isKnockout = false) {
            const level1 = countries[team1];
            const level2 = countries[team2];
            
            let prob1 = level1 / (level1 + level2);
            
            // Ajustar probabilidad si uno es el campe√≥n elegido
            if (team1 === chosenChampion) {
                prob1 = Math.min(0.85, prob1 + 0.3);
            } else if (team2 === chosenChampion) {
                prob1 = Math.max(0.15, prob1 - 0.3);
            }
            
            const random = Math.random();
            let winner, score1, score2;
            let penalties = null; // Para almacenar el resultado de los penales

            if (random < prob1) {
                winner = team1;
                score1 = Math.floor(Math.random() * 3) + 1;
                score2 = Math.floor(Math.random() * score1);
            } else {
                winner = team2;
                score2 = Math.floor(Math.random() * 3) + 1;
                score1 = Math.floor(Math.random() * score2);
            }
            
            // Ajustar para partidos m√°s realistas
            const levelDiff = Math.abs(level1 - level2);
            if (levelDiff <= 1) {
                // Equipos similares, m√°s empates posibles
                if (Math.random() < 0.2) {
                    score1 = score2 = Math.floor(Math.random() * 3);
                }
            }

            // Si es fase eliminatoria y hay empate, ir a penales (excepto en la propia final que ya tiene su l√≥gica)
            if (isKnockout && score1 === score2 && !isFinal) {
                penalties = simulatePenalties(team1, team2);
                winner = penalties.winner;
            } else if (isFinal && score1 === score2) {
                // En la final, si hay empate, no hay penales en esta simulaci√≥n, forzamos un ganador en tiempo extra simulado
                if (Math.random() < 0.5) {
                    score1++;
                    winner = team1;
                } else {
                    score2++;
                    winner = team2;
                }
            }
            
            return { team1, team2, score1, score2, winner, penalties }; // Devuelve tambi√©n el resultado de los penales
        }
        
        // Simular fase de grupos
        function simulateGroups() {
            const groupResults = {}; // Esto ser√° local y luego se usa para cargar qualifiedTeamsForKnockoutGlobal
            
            Object.entries(groups).forEach(([letter, teams]) => { // 'groups' es la variable global
                const matches = [];
                const standings = teams.map(team => ({
                    team,
                    points: 0,
                    goals: 0,
                    goalsAgainst: 0,
                    diff: 0
                }));
                
                // Todos contra todos
                for (let i = 0; i < teams.length; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        const match = simulateMatch(teams[i], teams[j]); // No es eliminatoria aqu√≠
                        matches.push(match);
                        
                        // Actualizar estad√≠sticas
                        const team1Stats = standings.find(s => s.team === match.team1);
                        const team2Stats = standings.find(s => s.team === match.team2);
                        
                        team1Stats.goals += match.score1;
                        team1Stats.goalsAgainst += match.score2;
                        team2Stats.goals += match.score2;
                        team2Stats.goalsAgainst += match.score1;
                        
                        if (match.score1 > match.score2) {
                            team1Stats.points += 3;
                        } else if (match.score2 > match.score1) {
                            team2Stats.points += 3;
                        } else {
                            team1Stats.points += 1;
                            team2Stats.points += 1;
                        }
                    }
                }
                
                // Calcular diferencia de goles y ordenar
                standings.forEach(s => s.diff = s.goals - s.goalsAgainst);
                standings.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.diff !== a.diff) return b.diff - a.diff;
                    return b.goals - a.goals;
                });
                
                groupResults[letter] = { matches, standings };
            });
            
            displayGroups(groupResults); // Muestra los resultados de los grupos
            
            // Recopilar los clasificados para las eliminatorias y guardarlos en la variable global
            qualifiedTeamsForKnockoutGlobal = [];
            Object.values(groupResults).forEach(group => {
                qualifiedTeamsForKnockoutGlobal.push(group.standings[0].team, group.standings[1].team);
            });
        }
        
        function displayGroups(groupResults) {
            const content = document.getElementById('groupsContent');
            let html = '';
            
            Object.entries(groupResults).forEach(([letter, result]) => {
                html += `<div class="group">
                    <h3>Grupo ${letter}</h3>
                    <table class="group-table">
                        <tr>
                            <th>Pos</th>
                            <th>Equipo</th>
                            <th>Pts</th>
                            <th>GF</th>
                            <th>GC</th>
                            <th>Dif</th>
                        </tr>`;
                
                result.standings.forEach((team, index) => {
                    const qualified = index < 2 ? 'qualified' : '';
                    html += `<tr class="${qualified}">
                        <td>${index + 1}</td>
                        <td>${team.team} ${'‚≠ê'.repeat(countries[team.team])}</td>
                        <td>${team.points}</td>
                        <td>${team.goals}</td>
                        <td>${team.goalsAgainst}</td>
                        <td>${team.diff}</td>
                    </tr>`;
                });
                
                html += '</table><h4>Partidos:</h4>';
                
                result.matches.forEach(match => {
                    html += `<div class="match">
                        <div class="match-teams">
                            <span class="team-name">${match.team1}</span>
                            <span class="score">${match.score1} - ${match.score2}</span>
                            <span class="team-name">${match.team2}</span>
                        </div>
                    </div>`;
                });
                
                html += '</div>';
            });
            
            content.innerHTML = html;

            // A√±adir el bot√≥n para simular las eliminatorias
            const groupsSection = document.getElementById('groupsContent'); // Seleccionamos el contenedor interno
            const simulateKnockoutBtnDiv = document.createElement('div');
            simulateKnockoutBtnDiv.style.textAlign = 'center';
            simulateKnockoutBtnDiv.style.marginTop = '30px';
            simulateKnockoutBtnDiv.innerHTML = `<button class="simulate-btn" onclick="simulateKnockoutAndShow()">‚ñ∂Ô∏è Simular Eliminatorias</button>`;
            groupsSection.appendChild(simulateKnockoutBtnDiv); // A√±adir el bot√≥n al final del contenido de grupos
        }
        
        // Simular eliminatorias
        function simulateKnockout() { 
            const rounds = ['Octavos', 'Cuartos', 'Semifinal'];
            let currentTeams = [...qualifiedTeamsForKnockoutGlobal]; // Usa la variable global
            knockoutResults = {};
            
            rounds.forEach(round => {
                const matches = [];
                const winners = [];
                
                // Los emparejamientos de octavos son espec√≠ficos (A1 vs B2, C1 vs D2, etc.)
                // Asumimos que qualifiedTeamsForKnockoutGlobal es un array de 16 equipos, donde:
                // Los 2 primeros son de Grupo A, los 2 siguientes de Grupo B, etc.
                // Para un sorteo de octavos "realista" necesitar√≠as emparejar por posici√≥n de grupo.
                // Para simplificar, aqu√≠ se emparejar√°n secuencialmente de la lista actual de equipos.
                // Si quieres emparejamientos tipo "A1 vs B2", tendr√≠as que reordenar `currentTeams` antes de este bucle.
                
                for (let i = 0; i < currentTeams.length; i += 2) {
                    const team1 = currentTeams[i];
                    const team2 = currentTeams[i + 1];
                    // Pasar isKnockout = true para activar la l√≥gica de penales
                    const match = simulateMatch(team1, team2, false, true); 
                    matches.push(match);
                    winners.push(match.winner);
                }
                
                knockoutResults[round] = matches;
                currentTeams = winners;
            });
            
            // Final y 3er puesto
            const finalMatch = simulateMatch(currentTeams[0], currentTeams[1], true, false); // Final no va a penales
            finalResults.final = finalMatch;
            
            // Partido por el 3er puesto (perdedores de semifinal)
            const semifinalMatches = knockoutResults.Semifinal;
            const semifinalLosers = semifinalMatches.map(match => 
                match.winner === match.team1 ? match.team2 : match.team1
            );
            // El partido por el 3er puesto tambi√©n puede ir a penales si empata
            const thirdPlaceMatch = simulateMatch(semifinalLosers[0], semifinalLosers[1], false, true); 
            finalResults.thirdPlace = thirdPlaceMatch;
        }
        
        function displayKnockout() {
            const content = document.getElementById('knockoutContent');
            let html = '';
            
            Object.entries(knockoutResults).forEach(([round, matches]) => {
                html += `<h3>${round} de Final</h3><div class="matches-container">`;
                matches.forEach(match => {
                    const winnerClass = match.winner === chosenChampion ? 'champion-celebration' : '';
                    let scoreDisplay = `${match.score1} - ${match.score2}`;
                    if (match.penalties) {
                        scoreDisplay += ` (${match.penalties.score1}-${match.penalties.score2} pen.)`;
                    }

                    html += `<div class="match ${winnerClass}">
                        <div class="match-teams">
                            <span class="team-name">${match.team1}</span>
                            <span class="score">${scoreDisplay}</span>
                            <span class="team-name">${match.team2}</span>
                        </div>
                        <div>üèÜ ${match.winner}</div>
                    </div>`;
                });
                html += '</div>';
            });
            
            content.innerHTML = html;

            // A√±adir bot√≥n para ver la final
            const knockoutSection = document.getElementById('knockoutContent'); // Contenedor interno
            const viewFinalBtnDiv = document.createElement('div');
            viewFinalBtnDiv.style.textAlign = 'center';
            viewFinalBtnDiv.style.marginTop = '30px';
            viewFinalBtnDiv.innerHTML = `<button class="simulate-btn" onclick="showFinalAndDisplay()">‚ñ∂Ô∏è Ver la Gran Final</button>`;
            knockoutSection.appendChild(viewFinalBtnDiv);
        }
        
        function displayFinal() {
            const content = document.getElementById('finalContent');
            const final = finalResults.final;
            const third = finalResults.thirdPlace;
            
            let finalScoreDisplay = `${final.score1} - ${final.score2}`;
            // En la final, ya no hay penales, se resuelve en simulateMatch con el "tiempo extra" simulado
            // if (final.penalties) {
            //     finalScoreDisplay += ` (${final.penalties.score1}-${final.penalties.score2} pen.)`;
            // }

            let thirdPlaceScoreDisplay = `${third.score1} - ${third.score2}`;
            if (third.penalties) {
                thirdPlaceScoreDisplay += ` (${third.penalties.score1}-${third.penalties.score2} pen.)`;
            }

            let html = `
                <div class="match final-match">
                    <h3>üèÜ GRAN FINAL üèÜ</h3>
                    <div class="match-teams">
                        <span class="team-name">${final.team1}</span>
                        <span class="score">${finalScoreDisplay}</span>
                        <span class="team-name">${final.team2}</span>
                    </div>
                </div>
                
                <div class="champion-celebration">
                    üéâ ¬°${final.winner} es el CAMPE√ìN DEL MUNDO! üéâ
                    ${final.winner === chosenChampion ? '<br>¬°Tu predicci√≥n fue correcta!' : '<br>¬°Sorpresa en el resultado!'}
                </div>
                
                <h3>Partido por el 3er Puesto</h3>
                <div class="match">
                    <div class="match-teams">
                        <span class="team-name">${third.team1}</span>
                        <span class="score">${thirdPlaceScoreDisplay}</span>
                        <span class="team-name">${third.team2}</span>
                    </div>
                    <div>ü•â ${third.winner}</div>
                </div>
            `;
            content.innerHTML = html;
        }
        
        function showPhase(phaseId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(phaseId).classList.add('active');
            
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.phase-btn[onclick="showPhase('${phaseId}')"]`).classList.add('active');
        }
        
        // --- Funciones para controlar el flujo ---

        function startTournament() {
            chosenChampion = document.getElementById('championSelect').value;
            if (!chosenChampion) {
                alert('Por favor, selecciona un equipo para comenzar la simulaci√≥n.');
                return;
            }
            
            qualifyTeams(); // Asegura que el campe√≥n est√© entre los clasificados
            showPhase('draw'); // Mueve a la fase de sorteo
            document.getElementById('drawContent').innerHTML = '<button class="draw-btn" onclick="performDraw()">üé≤ Realizar Sorteo</button>'; // Reset draw content with the draw button
        }

        function simulateGroupsAndShow() {
            simulateGroups(); // Esta funci√≥n ya se encarga de llamar a displayGroups y rellenar qualifiedTeamsForKnockoutGlobal
            showPhase('groups'); // Cambia a la secci√≥n de grupos
            // displayGroups ya a√±ade el bot√≥n para las eliminatorias
        }

        function simulateKnockoutAndShow() {
            simulateKnockout(); // Usa qualifiedTeamsForKnockoutGlobal
            displayKnockout(); // Muestra los resultados de eliminatorias y a√±ade el bot√≥n para la final
            showPhase('knockout'); // Cambia a la secci√≥n de eliminatorias
        }

        function showFinalAndDisplay() {
            displayFinal(); // Muestra los resultados de la final
            showPhase('final'); // Cambia a la secci√≥n final
        }

        // Add this line to call the function when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeChampionSelector);
    </script>
</body>
</html>